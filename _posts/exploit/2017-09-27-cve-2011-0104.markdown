---
layout:		post
title:		CVE-2011-0104分析 & 复现
author:		wooy0ung
tags:		cve
category:  	exploit
---

- 目录
{:toc #markdown-toc}

>[分析环境]  
>系统: Windows XP SP3  
>漏洞软件: Microsoft Office Word 2003 SP3 English  
>说明: 这里的地址会和《漏洞战争》不太一致, 估计是版本不吻合。  
<!-- more -->


### 0x00 定位崩溃点

刚开始想用msf生成PoC, search一下居然没有收录, 直接用随书资料的PoC

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x00.png)

Windbg附加上去, Excel打开exploit.xlb, 触发异常

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x01.png)

异常的原因是esi引用了一个非法地址0x51453844, 将excel.exe拖到IDA分析, 定位到0x300ce361寻找esi的来源

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x02.png)

非法地址来源于栈传递的一个参数, 尝试在PoC中检索这个非法地址

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x03.png)

Windbg重新启动调试, 定位到300ce354 mov eax,dword ptr [ebp+2Ch], eax=51453844

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x04.png)

将PoC的44384551 4byte数据改成22222222, 再启动调试, 定位到0x300ce354发现eax=22222222


### 0x01 污点追踪

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x05.png)

用OD附加上excel, 定位到crachFun首部0x300CE252, 对栈顶下内存写入断点, F5运行

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x06.png)

断在了300CE3C8 rep movs dword ptr es:[edi],dword ptr ds:[esi]

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x07.png)

对比栈区的数据正好与PoC吻合

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x08.png)
![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x09.png)

再转到IDA, 定位到0x300CE3C8 rep movsd, ecx指定了需要传送多少字节

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x0a.png)

回到OD, 查看crashFun的调用栈, 发现被函数sub_306DF0E1引用

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x0b.png)

在IDA定位到0x306DF0E1这个地址, 这里就是vulnerFun主要作用的地方

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x0c.png)

直接显示伪C代码

![](/assets/img/exploit/2017-09-27-cve-2011-0104/0x0d.png)

来到这里发现进行不下去了, 留个坑, 未完...