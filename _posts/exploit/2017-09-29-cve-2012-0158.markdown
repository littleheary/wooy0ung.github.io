---
layout:		post
title:		CVE-2012-0158分析 & 复现
author:		wooy0ung
tags:		cve
category:  	exploit
---

- 目录
{:toc #markdown-toc}

>[分析环境]  
>系统: Windows XP SP3  
>漏洞软件: Microsoft Office Word 2003 SP3 English  
>注意: 对VulFun下断必须等到mscomctl.ocx加载完,也就是打开poc.doc后。
<!-- more -->


### 0x00 定位崩溃点

启动Word, 用Immunity Debugger附加上去, 打开PoC.doc崩溃断下

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x00.png)

EIP=41414141, 回溯到最近的返回地址MSCOMCTL.275C8A0A

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x01.png)

反汇编窗口跟随, 找到调用函数sub_275C89C7

```
275C8A05   E8 63FDFFFF      CALL MSCOMCTL.275C876D
```


### 0x01 windbg调试

因为一直在sub_275C89C7断不下, 改用windbg进行调试

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x03.png)

加载mscomctl.ocx时成功断下, 在0x275C89C7下断, 运行

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x04.png)

在sub_275C8A05下断, 先反编译一下函数

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x05.png)

发现有rep movsd内存copy指令, 很可疑, 跟进去

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x06.png)

单步到rep movsd, 打印esi指向的数据, 发现崩溃时出现的41414141

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x07.png)

回到sub_275C89C7开始, 分配了0x14的栈空间

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x08.png)

中间用了0x0C的空间

```
# 以上用到的命令
> sxe ld mscomctl.ocx
> uf MSCOMCTL!DllGetClassObject+0x41a29
```


### 0x02 exploit

将PoC.doc从D0CF11E0...开始到}前的字符作为hex保存, 用OffVis解析

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x09.png)

直接检索hex值41414141, 此处是返回地址, 用于劫持EIP

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x0a.png)

0x8282表示copy的长度

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x0b.png)

构造exploit, 将PoC的41414141处修改成万能跳jmp esp 0x7ffa4512

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x0c.png)

紧跟着0x7ffa4512布置一定量的nop后, 再放置shellcode

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x0d.png)

pwn~

![](/assets/img/exploit/2017-09-29-cve-2012-0158/0x0e.png)